// Inicializar el mapa centrado en León
const map = L.map("map").setView([42.598, -5.577], 14);

// Cargar los tiles del mapa (OpenStreetMap)
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:
    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);

// Array con todos los sectores y sus coordenadas
const sectores = [
  {
    nombre: "1 - Sector Ayuntamiento",
    coords: [
      [-5.576132872601505, 42.59914945946883],
      [-5.577745509518792, 42.59671521831859],
      [-5.5774945154458635, 42.5964519265751],
      [-5.572248739325374, 42.597814564806356],
      [-5.57226756388161, 42.59828570736411],
      [-5.575354790975723, 42.5993665503606],
      [-5.57549911256794, 42.59920950596077],
      [-5.5757250072328475, 42.59913098361281],
      [-5.576019925268071, 42.59910788878591],
      [-5.576132872601505, 42.59914945946883],
    ],
  },
  {
    nombre: "2 - Sector Cortes Leonesas",
    coords: [
      [-5.577518292486701, 42.59643439648758],
      [-5.577551044550745, 42.59619010092476],
      [-5.574918794859087, 42.595289168483816],
      [-5.574339174557679, 42.59389470476236],
      [-5.572323414026414, 42.59395941145124],
      [-5.572323414026414, 42.594209610016236],
      [-5.571608531720415, 42.59678918583347],
      [-5.5722531063091765, 42.597802869158244],
      [-5.577518292486701, 42.59643439648758],
    ],
  },
  {
    nombre: "3 - Sector Padre Isla",
    coords: [
      [-5.574602913208139, 42.6014081770214],
      [-5.575650813461124, 42.59980081536543],
      [-5.575519041573358, 42.5997684829523],
      [-5.57534961889354, 42.59959296342504],
      [-5.5753182446338485, 42.59936663542865],
      [-5.572256116946733, 42.59829503048732],
      [-5.5719925731702915, 42.59845669620657],
      [-5.574602913208139, 42.6014081770214],
    ],
  },
  {
    nombre: "4 - Sector Condesa",
    coords: [
      [-5.580973209579696, 42.6012056734684],
      [-5.5815373731464035, 42.600966440732094],
      [-5.5817949260789135, 42.60074074862936],
      [-5.578246666779933, 42.596787614860006],
      [-5.577737693128142, 42.59672893105699],
      [-5.576136213175431, 42.59916689530672],
      [-5.576270829661354, 42.59929301243395],
      [-5.576383078221795, 42.59961455451207],
      [-5.580973209579696, 42.6012056734684],
    ],
  },
  {
    nombre: "5 - Sector Gran Vía",
    coords: [
      [-5.579460042337416, 42.60193949978046],
      [-5.579460042337416, 42.60193949978046],
      [-5.57987242227054, 42.6018732136348],
      [-5.580957876224602, 42.601218050302606],
      [-5.576378521005438, 42.59963351881245],
      [-5.576302539228692, 42.59969344409788],
      [-5.576033889374514, 42.59981728950555],
      [-5.575955193963438, 42.59982527952357],
      [-5.575675689570318, 42.59981728950555],
      [-5.574691063330505, 42.60129954344467],
      [-5.575188651241746, 42.601840125471625],
      [-5.579460042337416, 42.60193949978046],
    ],
  },
  {
    nombre: "6 - Sector San Isidoro",
    coords: [
      [-5.574992011055372, 42.60190722710678],
      [-5.574590363504626, 42.60147745891919],
      [-5.572256118920137, 42.59877079067701],
      [-5.571597259478608, 42.598803123607155],
      [-5.571452937887386, 42.60058140894563],
      [-5.571997248591543, 42.60171741150353],
      [-5.571964796086775, 42.60185732405759],
      [-5.574992011055372, 42.60190722710678],
    ],
  },
  {
    nombre: "7 - Sector San Francisco",
    coords: [
      [-5.572246764027113, 42.59780519678472],
      [-5.571607141021758, 42.596789049999416],
      [-5.572322198741148, 42.59420808098429],
      [-5.572317185349107, 42.59390295108551],
      [-5.57054631275588, 42.59394142621679],
      [-5.569868930243899, 42.59404493282594],
      [-5.570320491117911, 42.59447233417373],
      [-5.570619084977153, 42.597400089010335],
      [-5.570433160976819, 42.59743532127197],
      [-5.570539929219393, 42.597925860618375],
      [-5.570420275160615, 42.597966512883346],
      [-5.570394503516724, 42.59816028831588],
      [-5.571586572543197, 42.59809465256285],
      [-5.571630033425066, 42.5980108628703],
      [-5.572246764027113, 42.59780519678472],
    ],
  },
  {
    nombre: "8 - Sector Lancia",
    coords: [
      [-5.577569509172378, 42.59616983531393],
      [-5.577726167883924, 42.59610693176816],
      [-5.577868584893906, 42.59598811378632],
      [-5.577949287866147, 42.59586929557736],
      [-5.577673948313446, 42.59542547261805],
      [-5.577707178948714, 42.59528568520514],
      [-5.576517838544561, 42.593463822869666],
      [-5.57400243756112, 42.59309397686755],
      [-5.5722856772330545, 42.59327467337499],
      [-5.5723229196394755, 42.59395414714504],
      [-5.574339189275264, 42.59389283761723],
      [-5.574928714937926, 42.59528087173487],
      [-5.577569509172378, 42.59616983531393],
    ],
  },
  {
    nombre: "9 - Sector Corredera",
    coords: [
      [-5.572319355470739, 42.59390054134715],
      [-5.572305958766123, 42.593684805520894],
      [-5.572284142452929, 42.59326581044752],
      [-5.57221082864109, 42.59281786296174],
      [-5.572158645717963, 42.592316666421084],
      [-5.5722617359809306, 42.591640723266806],
      [-5.572270558055294, 42.59158717781085],
      [-5.572386261797931, 42.59104274668164],
      [-5.572562344637902, 42.59031374801634],
      [-5.572685838439867, 42.58981591691031],
      [-5.572795670857772, 42.58936380754071],
      [-5.572844700448172, 42.589163710618436],
      [-5.572838819064117, 42.5890202784565],
      [-5.5714498540531, 42.58947999767716],
      [-5.571340726395135, 42.590289873425064],
      [-5.571235881755314, 42.59100222996193],
      [-5.571099422841002, 42.59173560039227],
      [-5.571010559514832, 42.59231291606619],
      [-5.570906925464158, 42.59286686060889],
      [-5.570533525062558, 42.59381484647858],
      [-5.57054704583561, 42.593939266225675],
      [-5.572319355470739, 42.59390054134715],
    ],
  },
  {
    nombre: "10 - Sector Chantría",
    coords: [
      [-5.570535799425329, 42.59384327378862],
      [-5.570533081652883, 42.593814311859546],
      [-5.570905364069489, 42.592867371878526],
      [-5.570993578439072, 42.592358766995574],
      [-5.567274295592313, 42.59165271256916],
      [-5.56701859265786, 42.59252422221127],
      [-5.570535799425329, 42.59384327378862],
    ],
  },
  {
    nombre: "11 - Sector Corte Inglés",
    coords: [
      [-5.570994830641013, 42.59235663892062],
      [-5.571233701221956, 42.59100454897515],
      [-5.571353474877185, 42.59018792666237],
      [-5.571449642344618, 42.58947870769643],
      [-5.571386190013129, 42.58738691526844],
      [-5.5683017064925195, 42.587463257180985],
      [-5.568415308780459, 42.59122077531234],
      [-5.568882383955923, 42.591954242479574],
      [-5.570994830641013, 42.59235663892062],
    ],
  },
  {
    nombre: "12 - Sector José Aguado",
    coords: [
      [-5.568876503322798, 42.591954888847226],
      [-5.568410443937893, 42.591220659598406],
      [-5.568296528083664, 42.58746608927868],
      [-5.567087889339064, 42.58749063658669],
      [-5.567118157759097, 42.588912692377534],
      [-5.566096590341232, 42.58893277770929],
      [-5.565990663212432, 42.58751076634806],
      [-5.565453564758428, 42.58751870004994],
      [-5.565434357128652, 42.58723659590851],
      [-5.565132694486152, 42.58723220455289],
      [-5.565320355701147, 42.591841299017545],
      [-5.567265912349285, 42.59164704875516],
      [-5.568876503322798, 42.591954888847226],
    ],
  },
  {
    nombre: "13 - Sector Av. Peregrinos",
    coords: [
      [-5.582645265533955, 42.603582968695605],
      [-5.582272765497578, 42.603471258226364],
      [-5.582045719997637, 42.60338210650994],
      [-5.58171994908335, 42.603212296193504],
      [-5.581453448203774, 42.60303371971315],
      [-5.581175322955062, 42.60283864739637],
      [-5.580999088179482, 42.60261673845184],
      [-5.580842733116924, 42.60235074418355],
      [-5.580776722101831, 42.602200410650795],
      [-5.580725436050244, 42.60220979036413],
      [-5.580851116837863, 42.60249375799515],
      [-5.581031422961075, 42.6027559279629],
      [-5.581201793554101, 42.60291944173849],
      [-5.581515729524909, 42.603142735540956],
      [-5.582263660878766, 42.603510304118885],
      [-5.582638314998178, 42.603616311027935],
      [-5.582645265533955, 42.603582968695605],
    ],
  },
  {
    nombre: "14 - Sector Auditorio",
    coords: [
      [-5.580278956897416, 42.60767716328638],
      [-5.580370930750092, 42.60765459805933],
      [-5.577188321331249, 42.60409346826589],
      [-5.579451107811167, 42.60324490430804],
      [-5.579346860272835, 42.601935926569496],
      [-5.575097237581787, 42.60190432509151],
      [-5.580278956897416, 42.60767716328638],
    ],
  },
  {
    nombre: "15 - Sector San Claudio",
    coords: [
      [-5.5765238868994516, 42.59345768487344],
      [-5.576248343882156, 42.59304875575819],
      [-5.573071136199957, 42.58774235231837],
      [-5.572497436756549, 42.58771138592053],
      [-5.573251153871865, 42.588217994200875],
      [-5.5736179110374735, 42.588831118386395],
      [-5.572844865140212, 42.58907162425726],
      [-5.5728499118277455, 42.58915722832745],
      [-5.57256390306037, 42.59032524271254],
      [-5.57238556833596, 42.59106344648205],
      [-5.572272109280334, 42.591600970303176],
      [-5.5721620383881145, 42.59231847816284],
      [-5.572215875286503, 42.59283000326562],
      [-5.572284545889289, 42.59326853303986],
      [-5.573997609220584, 42.59308899831305],
      [-5.5765238868994516, 42.59345768487344],
    ],
  },
  {
    nombre: "16 - Sector Maestro Nicolás",
    coords: [
      [-5.569613991100681, 42.58742749670924],
      [-5.5695813598951815, 42.586656443838024],
      [-5.565441548332274, 42.58705625667261],
      [-5.56545816187284, 42.587515890193146],
      [-5.569613991100681, 42.58742749670924],
    ],
  },
  {
    nombre: "17 - Sector Santa Ana",
    coords: [
      [-5.568673359837447, 42.59322227705303],
      [-5.565804940671882, 42.592106111937966],
      [-5.565219382267969, 42.59246222100853],
      [-5.565564244330176, 42.59367226185421],
      [-5.566088520858216, 42.59507583762354],
      [-5.5666102775034005, 42.59560703389087],
      [-5.567864446478183, 42.59374799045477],
      [-5.568673359837447, 42.59322227705303],
    ],
  },
];

// Función para determinar el color según la ocupación
function obtenerColor(ocupacion) {
  if (ocupacion >= 100) return "black";
  if (ocupacion >= 90) return "red";
  if (ocupacion >= 75) return "orange";
  if (ocupacion >= 50) return "yellow";
  return "green";
}

const sectorMapping = sectorPoligonos = {
  1: "1 - Sector Ayuntamiento",
  2: "2 - Sector Cortes Leonesas",
  3: "3 - Sector Padre Isla",
  4: "4 - Sector Condesa",
  5: "5 - Sector Gran Vía",
  6: "6 - Sector San Isidoro",
  7: "7 - Sector San Francisco",
  8: "8 - Sector Lancia",
  9: "9 - Sector Corredera",
  10: "10 - Sector Chantría",
  11: "11 - Sector Corte Inglés",
  12: "12 - Sector José Aguado",
  13: "13 - Sector Av. Peregrinos",
  14: "14 - Sector Auditorio",
  15: "15 - Sector San Claudio",
  16: "16 - Sector Maestro Nicolás",
  17: "17 - Sector Santa Ana",
};

// Función para que los minutos solo sean 0, 15, 30 o 45
function redondearMinutos(mins){
  if (mins < 15) return 0;
  if (mins < 30) return 15;
  if (mins < 45) return 30;
  return 45;
}


// Dibujar los sectores en el mapa
sectores.forEach((sector) => {
  const transformedCoords = sector.coords.map((coord) => [coord[1], coord[0]]);
  const polygon = L.polygon(transformedCoords, {
    color: "blue",
    fillColor: "blue",
    fillOpacity: 0.5,
  }).addTo(map);

  polygon.bindPopup(sector.nombre);
  sectorPoligonos[sector.nombre] = polygon; // Guardamos referencia al polígono
});

// Evento al hacer clic en el botón "Enviar"
document.getElementById("btnEnviar").addEventListener("click", () => {
  const horaSeleccionada = parseInt(
    document.getElementById("horaSelect").value
  ); // Convertimos a número

  const minSeleccionados = parseInt(
    document.getElementById("horaSelect").value.split(":")[1]
  );

  const fecha = document.getElementById("fechaSelect").value.split("-");
  const ano = fecha[0]
  const mes = fecha[1]
  const dia = fecha[2]

  console.log(`Hora seleccionada: ${horaSeleccionada}`);
  console.log(`Minutos seleccionados: ${minSeleccionados}`);
  console.log(`Fecha seleccionada: ${dia}/${mes}/${ano}`);
  const minsRedondeados = redondearMinutos(minSeleccionados)
  console.log(`Hora a buscar: ${horaSeleccionada}:${minsRedondeados}`)

  obtenerDatosPorHora(horaSeleccionada, minSeleccionados, dia, mes, ano);
});

// Función para obtener datos de la API
async function obtenerDatosPorHora(hora, mins, dia, mes, ano) {
  try {
    
    let horaEncontrada = false;

    const minsRedondeados = redondearMinutos(mins)

    // Consultar datos para cada sector
    let cont = 1;
    for (const sectorId in sectorMapping) {
      const response = await fetch(
        `http://localhost:3001/api/tdo?sector=${cont}&day=${dia}&month=${mes}&year=${ano}&hour=${hora}&minute=${minsRedondeados}`
      );
      cont++;
      if (!response.ok) break;

      const sectorData = await response.json();
      horaEncontrada = true;

      const sectorNombre = sectorPoligonos[sectorMapping[sectorId]];
      if (sectorNombre) {
        const ocupacion = sectorData.ocupacion;
        const color = obtenerColor(parseFloat(ocupacion));

        console.log(`Actualizando ${sectorMapping[sectorId]} a ${color}`);
        
        sectorNombre.setStyle({ fillColor: color });
        sectorNombre.bindPopup(
          `${sectorMapping[sectorId]}<br>Ocupación: ${ocupacion}%`
        );
      }
    }
    cont = 1

    if (!horaEncontrada) {
      mostrarErrorServicioNoDisponible();
    }

  } catch (error) {
    console.error("[!] Error accediendo a la API:", error);
    mostrarErrorServicioNoDisponible();
  }
}

// Función para manejar el caso de no disponibilidad
function mostrarErrorServicioNoDisponible() {
  Swal.fire({
    icon: "warning",
    title: "Oops...",
    text: "En estos momentos no hay servicio de la ORA",
    footer: "Seleccione otra fecha y hora válidas (Laborables: 10:00 - 14:00 y 16:00 - 20:00).",
  });
  
  // Resetear todos los sectores a azul
  for (const sector in sectorPoligonos) {
    if (sectorPoligonos.hasOwnProperty(sector)) {
      const poligono = sectorPoligonos[sector];
      if (typeof poligono.setStyle === "function") {
        poligono.setStyle({ fillColor: "blue" });
        poligono.bindPopup(`${sector}<br>Ocupación: NO DISPONIBLE`);
      }
    }
  }
}

